# Function
Run this script to get TiDBCloud Cluster Metrics, a capacity plan will be generated based on the metrics and estimated traffic increase and resource redundancy required.
It will be saved in a csv file.


# Requirement
- Python3.8+
- prometheus_api_client: A Python wrapper for the Prometheus http api and some tools for metrics processing.
```shell
pip install prometheus-api-client
```
- pyyaml
```shell
pip install pyyaml
```

# How to use
1. Configuration in yaml file `tidbcloud.yaml` 
- `logging.level`: case-insensitive, must be one of "debug", "info", "warning", "error", "critical" 
- `logging.to_file`: if ture, a log file will be generated under `logs`, otherwise only console log  
- `prometheus.start_time`: Prometheus query start time, format: 'dd-mm-YYYY HH:MM:SS'
- `prometheus.end_time`: Prometheus query ent time, format:'dd-mm-YYYY HH:MM:SS'
- `prometheus.step_in_seconds`: Prometheus query step(interval), unit is second, normally 60 for two days, 30 for 1 day
- `prometheus.cluster_prom_id_token`: Token for prometheus API
- `prometheus.cluster_prom_base_url`: URL for prometheus API, contains TiDBCloud Cluster information
- `capacity.plan_traffic_x`: Estimated times of traffic increase 
- `capacity.plan_resource_redundancy_x`: Times of resource redundancy required

2. How to get `prometheus.cluster_prom_id_token` and `prometheus.cluster_prom_base_url`
- step 1, login tidbcloud.com in Chrome
- step 2, right-click the page to `Inspect`
- step 3, goto `Application` tab, 
- step 4, under `Local storage` -> https://tidbcloud.com

# A glance of capacity plan
|component|name         |max               |average           |percentile_50.0    |percentile_75.0   |percentile_80.0   |percentile_85.0   |percentile_90.0   |percentile_95.0   |percentile_99.0   |percentile_99.9   |capacity     |instance_cnt|plan_max          |plan_average       |plan_percentile_50.0|plan_percentile_75.0|plan_percentile_80.0|plan_percentile_85.0|plan_percentile_90.0|plan_percentile_95.0|plan_percentile_99.0|plan_percentile_99.9|
|---------|-------------|------------------|------------------|-------------------|------------------|------------------|------------------|------------------|------------------|------------------|------------------|-------------|------------|------------------|-------------------|--------------------|--------------------|--------------------|--------------------|--------------------|--------------------|--------------------|--------------------|
|tidb     |CPU(core)    |19.133333333333333|9.130534955810484 |9.639999999999418  |11.575500000019868|12.076000000016453|12.613699999942133|13.245333333313464|14.072566666658968|15.412513333301993|16.97410333333528 |32           |28          |66.96666666666667 |31.956872345336695 |33.73999999999796   |40.51425000006954   |42.26600000005759   |44.14794999979747   |46.358666666597124  |49.25398333330639   |53.94379666655698   |59.409361666673476  |
|tidb     |Memory(byte) |21957095424.0     |17453655280.138306|17429174272.0      |17926579200.0     |18060755763.2     |18223577702.4     |18443410227.2     |18788643225.6     |19547643412.479992|20550619136.000034|66206752768  |28          |37.14416709282582 |29.52583097113195  |29.48441717575826   |30.325862339686104  |30.552844852044927  |30.828285897376098  |31.20017005946266   |31.78419048342594   |33.068168588022644  |34.764872871766634  |
|tikv     |CPU(core)    |20.625            |10.095236426022822|10.791666666666666 |12.258333333333333|12.575            |12.941666666666666|13.391666666666667|14.033333333333333|15.316666666666666|17.035666666666717|32           |27          |69.609375         |34.07142293782702  |36.421875           |41.371874999999996  |42.440625           |43.678125           |45.196875000000006  |47.3625             |51.69375            |57.49537500000017   |
|tikv     |Memory(byte) |64757587968.0     |63154024284.59444 |63918501888.0      |64091537408.0     |64131703603.2     |64179776307.2     |64239892889.6     |64322052915.2     |64459135877.12    |64591471394.816   |132135682048 |27          |52.92907556948474 |51.618416138787666 |52.24325554543491   |52.38468468758904   |52.417514192945696  |52.45680601746675   |52.5059418057608    |52.57309461889402   |52.68513823692281   |52.79330157092654   |
|tikv     |Storage(byte)|535961378515.0    |432306167962.59607|458253552019.0     |491701227618.0    |497623375915.2    |503519414160.5    |509573539586.2    |516538886515.8    |525188122942.27997|530738754529.2004 |2113559478272|27          |27.386893756566792|22.090254199106965 |23.416130053039755  |25.125260551531984  |25.427874233651078  |25.729153727811802  |26.038511260778026  |26.39443096690895   |26.836395124370725  |27.12002481047614   |
|pd       |CPU(core)    |8.020666666639348 |2.332409972299065 |0.15066666666534728|6.622666666656732 |6.8479999999826155|6.985733333329359 |7.12080000003179  |7.300399999991059 |7.5884266666794815|7.8683520000249185|32           |3           |3.0077499999897555|0.8746537396121494 |0.05649999999950523 |2.4834999999962744  |2.567999999993481   |2.6196499999985097  |2.6703000000119212  |2.7376499999966475  |2.8456600000048056  |2.9506320000093442  |
|pd       |Memory(byte) |2815262720.0      |1628184197.7913203|1102213120.0       |2649124864.0      |2660732928.0      |2680143872.0      |2732572672.0      |2750545920.0      |2788675584.0      |2807190323.200006 |66206752768  |3           |0.5102674761648869|0.29510902674778716|0.19977656186141862 |0.4801549243684544  |0.4822588905377079  |0.48577713177838966 |0.49527987241580823 |0.4985375306905733  |0.5054485472994584  |0.5088043510673704  |
|tiflash  |CPU(core)    |4.375             |2.1108198614318705|2.075              |2.425             |2.525             |2.6416666666666666|2.8               |3.0               |3.3921666666666623|4.083433333333339 |32           |3           |1.640625          |0.7915574480369514 |0.7781250000000001  |0.9093749999999999  |0.9468749999999999  |0.990625            |1.0499999999999998  |1.125               |1.2720624999999983  |1.5312875000000021  |
|tiflash  |Memory(byte) |18448875520.0     |13572061675.583063|13429231616.0      |13907263488.0     |14052513382.4     |14224212787.199999|14463580569.6     |14894157824.0     |16053884518.399996|17488448110.592045|267057463296 |3           |0.8289845320466501|0.6098490493279397 |0.6034311020672896  |0.6249110577038108  |0.6314377381840642  |0.6391529049207314  |0.649908692657756   |0.6692563154091677  |0.7213676481577118  |0.7858285431794854  |
|tiflash  |Storage(byte)|571533776920.0    |563293596854.1827 |563225580356.0     |565520096000.5    |566055551791.0    |566694664327.2    |567275747075.2    |568100122776.8    |569746993925.34   |570806903414.718  |1585119989760|3           |4.3267420557092455|4.264360556877237  |4.263845644452016   |4.281216056731132   |4.285269673824796   |4.29010801444503    |4.294507046077364   |4.300747903856654   |4.313215385126303   |4.321239329026261   |


# How to read
For example, `plan_max` is the calculated number of instance needed based on `max` value  

# How capacity plan is calculated 
```plan_max = max * instance_cnt * plan_traffic_x * plan_resource_redundancy_x / capacity ```


>**For On-premise deployment TiDB cluster, please download v0.1.0**


